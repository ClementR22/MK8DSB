name: Build and release

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      stable:
        type: boolean
        description: Stable release ?
        default: false
      platform:
        type: choice
        description: Target platform
        required: true
        options: [android, ios, all]
        default: android
      version-bump:
        type: choice
        description: Version level
        required: false
        options: [major, minor, patch]
        default: patch
      reset-cache:
        type: boolean
        default: false
        description: Delete cache ?
      skip-build:
        type: boolean
        default: false
        description: Skip binary build ?
      is-draft:
        type: boolean
        description: Draft release ?
        default: false
      description:
        required: false
        description: Release description

env:
  GITHUB_TOKEN: ${{ github.token }}

jobs:
  # 1. Préparation : On calcule la version une seule fois pour tout le monde
  prepare:
    runs-on: ubuntu-latest
    outputs:
      next-version: ${{ steps.version_build.outputs.v-version || steps.nightly-version.outputs.value }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Calculate stable version
        id: version_build
        if: ${{ inputs.stable }}
        uses: reecetech/version-increment@2024.10.1
        with:
          scheme: semver
          increment: ${{ inputs.version-bump }}
          tag_prefix: v
      - name: Get tag & commit
        id: info
        run: |
          echo "tag=$(git tag -l --sort=-version:refname | grep -v '-' | head -n 1)" >> "$GITHUB_OUTPUT"
          echo "hash=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
      - name: Store nightly version
        id: nightly-version
        if: ${{ !inputs.stable }}
        run: echo "value=${{ steps.info.outputs.tag || 'v0.0.0' }}-${{ steps.info.outputs.hash }}" >> "$GITHUB_OUTPUT"

  # 2. Build : En parallèle sur les bons OS (macOS pour iOS, Ubuntu pour Android)
  build:
    needs: [prepare]
    if: ${{ !inputs.skip-build }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - ${{ (inputs.platform == 'all' || inputs.platform == 'android') && 'android' || '' }}
          - ${{ (inputs.platform == 'all' || inputs.platform == 'ios') && 'ios' || '' }}
        exclude:
          - platform: ""

    runs-on: ${{ matrix.platform == 'ios' && 'macos-latest' || 'ubuntu-latest' }}

    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v5
        with:
          node-version: 20.x
          cache: npm
      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - run: npm install

      - name: Update Version Files
        run: |
          VERSION="${{ needs.prepare.outputs.next-version }}"
          CLEAN_VERSION="${VERSION#v}"
          # Update package.json
          node -e "const fs = require('fs'); const pkg = require('./package.json'); pkg.version = '$CLEAN_VERSION'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));"
          # Update app.config.ts (Fix for macOS sed incompatibility)
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i "" "s/{{VERSION}}/$VERSION/g" app.config.ts
          else
            sed -i "s/{{VERSION}}/$VERSION/g" app.config.ts
          fi

      - name: Android Version Code
        id: android-version
        if: ${{ matrix.platform == 'android' }}
        run: |
          VCODE=$(eas app:inspect --platform android --non-interactive 2>/dev/null | grep versionCode | awk '{print $2}' | tr -d '",') || echo "0"
          echo "value=$((${VCODE:-0} + 1))" >> "$GITHUB_OUTPUT"

      - name: Build Binary
        env:
          ANDROID_VERSION_CODE: ${{ steps.android-version.outputs.value }}
        run: eas build --platform ${{ matrix.platform }} --profile preview --local --non-interactive --app-version-source local

      - name: Package Artifact
        run: |
          VERSION="${{ needs.prepare.outputs.next-version }}"
          PREFIX="${{ inputs.stable && 'mk8dsb_' || 'mk8dsb-nightly_' }}"
          FILE_NAME=""
          if [ -f build-*.apk ]; then
            FILE_NAME="${PREFIX}${VERSION}.apk"
            mv build-*.apk "$FILE_NAME"
          elif [ -f build-*.ipa ]; then
            FILE_NAME="${PREFIX}${VERSION}.ipa"
            mv build-*.ipa "$FILE_NAME"
          fi
          # Checksum generation
          shasum -a 256 "$FILE_NAME" > "checksum-${{ matrix.platform }}.txt"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform }}
          path: |
            *.apk
            *.ipa
            checksum-*.txt
          if-no-files-found: error

  # 3. Release : On regroupe les artefacts et on publie
  publish:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: build-*
          merge-multiple: true

      - name: Merge Checksums
        run: cat dist/checksum-*.txt > sha256sum.txt

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ github.token }}
          tag: ${{ inputs.stable && needs.prepare.outputs.next-version || format('nightly-{0}', needs.prepare.outputs.next-version) }}
          name: ${{ inputs.stable && format('MK8DSB {0}', needs.prepare.outputs.next-version) || format('Nightly {0}', needs.prepare.outputs.next-version) }}
          prerelease: ${{ !inputs.stable }}
          draft: ${{ inputs.is-draft }}
          body: |
            ${{ inputs.description || 'Nouveau build disponible.' }}

            **Version:** ${{ needs.prepare.outputs.next-version }}
            **Commit:** ${{ github.sha }}
          artifacts: "dist/*.apk,dist/*.ipa,sha256sum.txt"
