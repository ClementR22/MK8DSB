name: Build and release

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      stable:
        type: boolean
        description: Stable release ?
        default: false
      version-bump:
        type: choice
        description: Version level
        required: false
        options:
          - major
          - minor
          - patch
        default: patch
      skip-build:
        type: boolean
        default: false
        description: Skip APK build ?
      is-draft:
        type: boolean
        default: false
        description: Draft release ?
      description:
        required: false
        description: Description

env:
  GITHUB_TOKEN: ${{ github.token }}

jobs:
  check-stable-inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        shell: bash
        run: |
          if [ "${{ inputs.stable }}" = "true" ] && [ -z "${{ inputs.description }}" ]; then
            echo "âŒ Missing description for stable release"
            exit 1
          fi

  build:
    runs-on: ubuntu-latest
    needs: check-stable-inputs
    outputs:
      version: ${{ steps.final-version.outputs.value }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: 20.x
          cache: npm

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm install

      # ðŸ”¢ Compute version (SINGLE source of truth)
      - name: Compute version
        id: compute-version
        run: |
          if [ "${{ inputs.stable }}" = "true" ]; then
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            VERSION=$(npx semver "$LAST_TAG" -i ${{ inputs.version-bump }})
          else
            BASE=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            HASH=$(git rev-parse --short HEAD)
            VERSION="${BASE}-${HASH}"
          fi
          echo "value=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Expose final version
        id: final-version
        run: echo "value=${{ steps.compute-version.outputs.value }}" >> "$GITHUB_OUTPUT"

      # ðŸ§© Inject version into app.config.ts
      - name: Update app.config.ts
        run: |
          sed -i app.config.ts -e 's|{{VERSION}}|${{ steps.final-version.outputs.value }}|g'

      # ðŸ” Sync package.json + app.config.ts (STABLE ONLY)
      - name: Commit versioned files
        if: ${{ inputs.stable }}
        run: |
          VERSION="${{ steps.final-version.outputs.value }}"
          CLEAN_VERSION="${VERSION#v}"

          node -e "
            const fs = require('fs');
            const pkg = require('./package.json');
            pkg.version = '$CLEAN_VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add app.config.ts package.json
          git commit -m "CI: release $VERSION"
          git push --force-with-lease

      # ðŸ“Œ Android versionCode (strictly increasing)
      - name: Set Android versionCode
        run: |
          echo "ANDROID_VERSION_CODE=$(date +%s)" >> $GITHUB_ENV

      # ðŸ— Build APK
      - name: Build APK
        if: ${{ !inputs.skip-build }}
        run: eas build --non-interactive --platform android --profile preview --local

      # ðŸ“¦ Rename APK
      - name: Rename APK
        id: apk-name
        run: |
          if [ "${{ inputs.stable }}" = "true" ]; then
            NAME="mk8dsb_${{ steps.final-version.outputs.value }}.apk"
          else
            NAME="mk8dsb-nightly_${{ steps.final-version.outputs.value }}.apk"
          fi
          mv build-*.apk "$NAME"
          echo "value=$NAME" >> "$GITHUB_OUTPUT"

      - name: SHA256
        run: sha256sum ${{ steps.apk-name.outputs.value }} > sha256sum.txt

      - name: Generate changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            git log --pretty=format:'- %s' > changelog.txt
          else
            git log "$LAST_TAG"..HEAD --pretty=format:'- %s' > changelog.txt
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: |
            *.apk
            sha256sum.txt
            changelog.txt

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: ./

      - name: Publish GitHub release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ github.token }}
          tag: ${{ needs.build.outputs.version }}
          name: MK8DSB ${{ needs.build.outputs.version }}
          draft: ${{ inputs.is-draft }}
          prerelease: ${{ !inputs.stable }}
          bodyFile: changelog.txt
          artifacts: |
            *.apk
            sha256sum.txt
          allowUpdates: true
          replacesArtifacts: true
