name: Build and release

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      stable:
        type: boolean
        description: Stable release ?
        default: false
      version-bump:
        type: choice
        description: Version level
        required: false
        options:
          - major
          - minor
          - patch
        default: patch
      reset-cache:
        type: boolean
        default: false
        description: Delete cache ?
      skip-build:
        type: boolean
        default: false
        description: Skip APK build ?
      is-draft:
        type: boolean
        description: Draft release ?
        required: false
        default: false
      description:
        required: false
        description: Description

env:
  GITHUB_TOKEN: ${{ github.token }}

jobs:
  check-description:
    runs-on: ubuntu-latest
    steps:
      - name: Exit
        if: ${{inputs.stable && !inputs.description}}
        run: echo "Missing description for a stable release" && exit 1

  check-version-bump:
    runs-on: ubuntu-latest
    steps:
      - name: Exit
        if: ${{inputs.stable && !inputs.version-bump}}
        run: echo "Missing version bump for a stable release" && exit 1

  build:
    runs-on: ubuntu-latest
    needs: [check-description, check-version-bump]
    steps:
      - name: Setup repo
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: 18.x
          cache: npm

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm install

      - name: Get latest tag
        id: get-latest-tag
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: ClementR22/MK8DSB
          excludes: "prerelease"

      - name: Get latest commit hash
        id: get-latest-commit
        run: echo "value=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Store nightly version
        id: nightly-version
        run: |
          echo "${{steps.get-latest-tag.outputs.release}}-${{steps.get-latest-commit.outputs.value}}" > nightly-version.txt
          echo "value=$(cat nightly-version.txt)" >> "$GITHUB_OUTPUT"

      - name: Update app.config.ts - Nightly
        if: ${{!inputs.stable}}
        run: sed -i app.config.ts -e 's|{{VERSION}}|${{ steps.nightly-version.outputs.value }}|g'

      - name: Update app.config.ts - Stable
        if: ${{inputs.stable}}
        run: sed -i app.config.ts -e 's|{{VERSION}}|${{ steps.get-latest-tag.outputs.release }}|g'

      - name: Clean Android build
        if: ${{inputs.reset-cache}}
        run: |
          cd android && ./gradlew clean && cd ..
          rm -rf android/app/build

      - name: Build apk (local)
        if: ${{!inputs.skip-build}}
        run: eas build --non-interactive --platform android --profile preview --local --build-properties "gradleCommand=.:app:assembleRelease -x lintVitalAnalyzeRelease -x lintRelease" || exit 1

      - name: Store build name
        id: build-name
        run: echo "value=mk8dsb-nightly_${{steps.nightly-version.outputs.value}}.apk" >> "$GITHUB_OUTPUT"

      - name: Rename build
        run: mv build-*.apk ${{steps.build-name.outputs.value}}

      - name: Generate SHA256 checksum
        run: sha256sum ${{steps.build-name.outputs.value}} > sha256sum.txt && cat sha256sum.txt

      - name: Upload application artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: |
            ./${{steps.build-name.outputs.value}}
            ./sha256sum.txt
            ./nightly-version.txt

  nightly:
    if: ${{!inputs.stable}}
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Clear cache manually
        if: ${{inputs.reset-cache}}
        run: rm -rf ~/.npm ~/.gradle

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: ./

      - name: Get app-version
        id: nightly-version
        run: echo "value=$(cat nightly-version.txt)" >> "$GITHUB_OUTPUT"

      - name: Upload nightly release
        uses: ncipollo/release-action@v1
        env:
          GITHUB_TOKEN: ${{github.token}}
        with:
          tag: nightly-${{steps.nightly-version.outputs.value}}
          name: "Nightly release ${{steps.nightly-version.outputs.value}}"
          draft: ${{inputs.is-draft}}
          prerelease: true
          body: |
            Unstable release, things may break and you may lose your settings or data.
            **Use with caution.**
            ${{inputs.description}}
          artifacts: |
            mk8dsb-nightly_${{steps.nightly-version.outputs.value}}.apk
            sha256sum.txt

  release:
    if: ${{inputs.stable}}
    needs: [check-description, check-version-bump, build]
    runs-on: ubuntu-latest
    steps:
      - name: Setup github
        uses: actions/checkout@v5

      - name: Increment version
        uses: reecetech/version-increment@2024.10.1
        id: version
        with:
          scheme: "semver"
          increment: ${{inputs.version-bump}}
          tag_prefix: "v"

      - name: Bump package.json and app.json version
        uses: NoAccount1/gh-action-bump-version@master
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          version-type: ${{inputs.version-bump}}
          skip-tag: "true"
          bump-policy: "ignore"
          commit-message: "CI : bumps `package.json` to version ${{steps.version.outputs.v-version}}"

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: ./

      - name: List downloaded files
        run: ls -lRAh

      - name: Rename stable release
        run: mv app-release.apk mk8dsb_${{steps.version.outputs.v-version}}.apk

      - name: Upload stable release
        uses: ncipollo/release-action@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          name: MK8DSB ${{steps.version.outputs.v-version}}
          tag: ${{steps.version.outputs.v-version}}
          body: ${{inputs.description}}
          draft: ${{inputs.is-draft}}
          prerelease: false
          artifacts: |
            ./mk8dsb_${{steps.version.outputs.v-version}}.apk
            ./sha256sum.txt

  ota_update:
    name: Deploy OTA Update
    runs-on: ubuntu-latest
    needs: [build] # S'assure que ce job s'ex√©cute apr√®s la compilation et l'upload des artefacts
    # Condition: S'ex√©cute si le build n'est PAS ignor√© (si on a potentiellement des changements JS √† publier)
    if: ${{!inputs.skip-build}}
    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v5

      - name: üõ†Ô∏è Setup Node and Install dependencies
        uses: actions/setup-node@v5
        with:
          node-version: 18.x
          cache: npm

      - name: üîë Setup EAS and Login
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        run: npm install

      - name: Publish OTA (Nightly/Preview Channel)
        if: ${{!inputs.stable}}
        # Le canal 'preview' est utilis√© pour les Nightlies
        run: npx eas update --branch preview --message "Nightly OTA Update"

      - name: Publish OTA (Stable/Production Channel)
        if: ${{inputs.stable}}
        # Le canal 'production' est utilis√© pour les Stables
        run: npx eas update --branch production --message "Stable OTA Update"
