name: Build and release

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      stable:
        type: boolean
        description: Stable release ?
        default: false
      version-bump:
        type: choice
        description: Version level
        required: false
        options:
          - major
          - minor
          - patch
        default: patch
      reset-cache:
        type: boolean
        default: false
        description: Delete cache ?
      skip-build:
        type: boolean
        default: false
        description: Skip APK build ?
      is-draft:
        type: boolean
        description: Draft release ?
        required: false
        default: false
      description:
        required: false
        description: Description

env:
  GITHUB_TOKEN: ${{ github.token }}

jobs:
  check-description:
    runs-on: ubuntu-latest
    steps:
      - name: Exit
        if: ${{inputs.stable && !inputs.description}}
        run: echo "Missing description for a stable release" && exit 1

  check-version-bump:
    runs-on: ubuntu-latest
    steps:
      - name: Exit
        if: ${{inputs.stable && !inputs.version-bump}}
        run: echo "Missing version bump for a stable release" && exit 1

  build:
    runs-on: ubuntu-latest
    needs: [check-description, check-version-bump]
    steps:
      - name: Setup repo
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v5
        with:
          node-version: 20.x
          cache: npm

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm install

      - name: Get latest tag
        id: get-latest-tag
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: ClementR22/MK8DSB
          excludes: "prerelease"

      - name: Calculate next stable version
        id: version_build
        if: ${{inputs.stable}}
        uses: reecetech/version-increment@2024.10.1
        with:
          scheme: "semver"
          increment: ${{inputs.version-bump}}
          tag_prefix: "v"

      - name: Get latest commit hash
        id: get-latest-commit
        run: echo "value=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Store nightly version
        id: nightly-version
        run: |
          echo "${{steps.get-latest-tag.outputs.release}}-${{steps.get-latest-commit.outputs.value}}" > nightly-version.txt
          echo "value=$(cat nightly-version.txt)" >> "$GITHUB_OUTPUT"

      - name: Update app.config.ts - Nightly
        if: ${{!inputs.stable}}
        run: sed -i app.config.ts -e 's|{{VERSION}}|${{ steps.nightly-version.outputs.value }}|g'

      - name: Update app.config.ts - Stable
        if: ${{inputs.stable}}
        run: sed -i app.config.ts -e 's|{{VERSION}}|${{ steps.version_build.outputs.v-version }}|g'

      - name: Clean Android build
        if: ${{inputs.reset-cache}}
        run: |
          cd android && ./gradlew clean && cd ..
          rm -rf android/app/build

      - name: Build apk (local)
        if: ${{!inputs.skip-build}}
        run: |
          eas build --non-interactive --platform android --profile preview --local 
          # üîê Stop if build fails
          || { echo "‚ùå Build failed, aborting release."; exit 1; }

      - name: Store build name
        id: build-name
        run: |
          if ${{inputs.stable}}; then
              VERSION_TAG=${{ steps.version_build.outputs.v-version }}
              echo "value=mk8dsb_${VERSION_TAG}.apk" >> "$GITHUB_OUTPUT"
          else
              VERSION_TAG=${{steps.nightly-version.outputs.value}}
              echo "value=mk8dsb-nightly_${VERSION_TAG}.apk" >> "$GITHUB_OUTPUT"
          fi

      - name: Rename build
        run: mv build-*.apk ${{steps.build-name.outputs.value}}

      - name: Generate SHA256 checksum
        run: sha256sum ${{steps.build-name.outputs.value}} > sha256sum.txt && cat sha256sum.txt

      # üîß Generate changelog (safe mode)
      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "LOG=$(git log --pretty=format:'- %s')" >> "$GITHUB_OUTPUT"
          else
            echo "LOG=$(git log $LAST_TAG..HEAD --pretty=format:'- %s')" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload application artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: |
            ./${{steps.build-name.outputs.value}}
            ./sha256sum.txt
            ./nightly-version.txt

  nightly:
    if: ${{!inputs.stable}}
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Clear cache manually
        if: ${{inputs.reset-cache}}
        run: rm -rf ~/.npm ~/.gradle

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: ./

      - name: Get app-version
        id: nightly-version
        run: echo "value=$(cat nightly-version.txt)" >> "$GITHUB_OUTPUT"

      - name: Upload nightly release
        uses: ncipollo/release-action@v1
        with:
          GITHUB_TOKEN: ${{github.token}}
          tag: nightly-${{steps.nightly-version.outputs.value}}
          name: "Nightly ${{steps.nightly-version.outputs.value}}"
          draft: ${{inputs.is-draft}}
          prerelease: true
          body: |
            ‚ö†Ô∏è Unstable build (nightly)
            - Might crash or reset your data
            - Use with caution

            ${{inputs.description}}

          artifacts: |
            mk8dsb-nightly_${{steps.nightly-version.outputs.value}}.apk
            sha256sum.txt

  release:
    if: ${{inputs.stable}}
    needs: [check-description, check-version-bump, build]
    runs-on: ubuntu-latest
    steps:
      - name: Setup github
        uses: actions/checkout@v5

      - name: Increment version
        uses: reecetech/version-increment@2024.10.1
        id: version
        with:
          scheme: "semver"
          increment: ${{inputs.version-bump}}
          tag_prefix: "v"

      # üîß Validate tag format to avoid invalid tag releases
      - name: Validate version tag format
        run: |
          [[ "${{steps.version.outputs.v-version}}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]] \
          || { echo "‚ùå Invalid semantic version tag"; exit 1; }

      - name: Bump package.json and create commit
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          npm version ${{inputs.version-bump}} --no-git-tag-version 

          git add package.json
          git commit -m "CI: bump version to ${{steps.version.outputs.v-version}}"
          git push

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: ./

      - name: Upload stable release
        uses: ncipollo/release-action@v1
        with:
          GITHUB_TOKEN: ${{ github.token }}
          name: MK8DSB ${{steps.version.outputs.v-version}}
          tag: ${{steps.version.outputs.v-version}}
          body: |
            ${{inputs.description}}

            ## üîß Changelog
            ${{needs.build.outputs.changelog}}

          draft: ${{inputs.is-draft}}
          prerelease: false
          artifacts: |
            ./mk8dsb_${{steps.version.outputs.v-version}}.apk
            ./sha256sum.txt
